{%- liquid
  assign design_scroll_limit = limit | default: 8
  assign heading_text = heading | default: 'Más diseños'
  assign view_all_label = view_all_label | default: ''
  assign view_all_link = view_all_link | default: ''
  assign product_cards = related_products | default: empty
  assign cards_rendered = 0
-%}

{%- if product_cards != empty -%}
  <div class="product-design-scroll product__info--spacing">
    <div class="d-flex between-xs middle-xs mb-12">
      <span class="h6 m-zero">{{ heading_text }}</span>
      {%- if view_all_link != blank and view_all_label != blank -%}
        <a class="btn-link design-scroll__view-all" href="{{ view_all_link }}">{{ view_all_label }}</a>
      {%- endif -%}
    </div>
    <div class="design-scroll__wrapper">
      <div class="design-scroll__container scrollable scrollable-x disable-scrollbars" role="list" aria-label="{{ heading_text | escape }}" tabindex="0">
      {%- for related_product in product_cards -%}
        {%- if related_product.id != current_product.id -%}
          {%- assign cards_rendered = cards_rendered | plus: 1 -%}
          {%- if cards_rendered > design_scroll_limit -%}{% break %}{% endif -%}
          <a class="design-scroll-card d-flex fd-column scrollable-aln-start" role="listitem" href="{{ related_product.url }}" title="{{ related_product.title | escape }}">
            <div class="design-scroll-card__media media-wrapper of-cover">
              {%- if related_product.featured_media -%}
                {%- assign preview_image = related_product.featured_media | default: related_product.featured_image -%}
                {%- assign preview_alt = preview_image.alt | default: related_product.title -%}
                {{ preview_image | image_url: width: 360 | image_tag: sizes: '(min-width: 769px) 160px, 120px', class: 'media design-scroll-card__image', alt: preview_alt, decoding: 'async', loading: 'lazy' }}
              {%- else -%}
                {{ 'product-1' | placeholder_svg_tag: 'placeholder media design-scroll-card__image' }}
              {%- endif -%}
            </div>
            <span class="design-scroll-card__title subtext mt-8">{{ related_product.title }}</span>
          </a>
        {%- endif -%}
      {%- endfor -%}
      </div>
      <div class="design-scroll__bar" aria-hidden="true">
        <span class="design-scroll__bar-progress"></span>
      </div>
    </div>
  </div>

  {%- unless product_design_scroll_styles_loaded -%}
    {%- assign product_design_scroll_styles_loaded = true -%}
    <style>
      .product-design-scroll {
        margin-top: calc(var(--spacing) * 1.5);
      }
      .design-scroll-card {
        gap: 8px;
        text-decoration: none;
        min-width: 120px;
        scroll-snap-align: start;
        margin-right: calc(var(--spacing));
      }
      .design-scroll__wrapper {
        position: relative;
        padding-bottom: var(--spacing);
      }
      .design-scroll-card__media {
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 1/1;
        background-color: rgba(var(--color-normal-text-rgb), .06);
      }
      .design-scroll-card__image {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .design-scroll-card__title {
        display: block;
        text-align: center;
      }
      .design-scroll__container {
        display: flex;
        gap: calc(var(--spacing));
        padding-bottom: 8px;
        scroll-snap-type: x proximity;
        overflow-y: hidden;
        cursor: grab;
      }
      .design-scroll__container:active {
        cursor: grabbing;
      }
      .design-scroll__bar {
        width: 100%;
        height: 4px;
        border-radius: 999px;
        background: rgba(var(--color-normal-text-rgb), .12);
        overflow: hidden;
      }
      .design-scroll__bar-progress {
        display: block;
        height: 100%;
        width: 20%;
        background: rgba(var(--color-normal-text-rgb), .4);
        transform-origin: left center;
        transition: transform .2s ease;
        transform: scaleX(0);
      }
      @media (min-width: 769px) {
        .design-scroll-card {
          min-width: 160px;
        }
      }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.design-scroll__container[tabindex="0"]').forEach(function(container) {
          let isDown = false;
          let startX;
          let scrollLeft;
          const bar = container.closest('.design-scroll__wrapper').querySelector('.design-scroll__bar-progress');

          const updateBar = () => {
            if (!bar) return;
            const ratio = container.scrollWidth > container.clientWidth ? container.clientWidth / container.scrollWidth : 1;
            bar.style.transform = `scaleX(${ratio}) translateX(${(container.scrollLeft / container.scrollWidth) * (1 / ratio)}px)`;
          };

          const startDrag = (e) => {
            isDown = true;
            container.classList.add('is-dragging');
            startX = e.pageX || e.touches?.[0].pageX;
            scrollLeft = container.scrollLeft;
          };
          const endDrag = () => {
            isDown = false;
            container.classList.remove('is-dragging');
          };
          const drag = (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX || e.touches?.[0].pageX;
            const walk = (x - startX);
            container.scrollLeft = scrollLeft - walk;
            updateBar();
          };

          container.addEventListener('mousedown', startDrag);
          container.addEventListener('mouseleave', endDrag);
          container.addEventListener('mouseup', endDrag);
          container.addEventListener('mousemove', drag);

          container.addEventListener('touchstart', startDrag, { passive: true });
          container.addEventListener('touchend', endDrag);
          container.addEventListener('touchmove', drag, { passive: false });
          container.addEventListener('scroll', updateBar);
          window.addEventListener('resize', updateBar);
          updateBar();
        });
      });
    </script>
  {%- endunless -%}
{%- endif -%}

