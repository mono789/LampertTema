{%- liquid
  assign recommended_scroll_limit = limit | default: 8
  assign heading_text = heading | default: 'Recomendados para ti'
  assign view_all_label = view_all_label | default: ''
  assign view_all_link = view_all_link | default: ''
  assign product_cards = related_products | default: empty
  assign cards_rendered = 0
-%}

{%- if product_cards != empty -%}
  <div class="product-recommended-scroll product__info--spacing">
    <div class="d-flex between-xs middle-xs mb-12">
      <span class="h6 m-zero">{{ heading_text }}</span>
      {%- if view_all_link != blank and view_all_label != blank -%}
        <a class="btn-link recommended-scroll__view-all" href="{{ view_all_link }}">{{ view_all_label }}</a>
      {%- endif -%}
    </div>
    <div class="recommended-scroll__container scrollable scrollable-x disable-scrollbars" role="list" aria-label="{{ heading_text | escape }}">
      {%- for related_product in product_cards -%}
        {%- if related_product.id != current_product.id -%}
          {%- liquid
            assign has_available_variant = false
            for variant in related_product.variants
              if variant.available
                assign has_available_variant = true
                break
              endif
            endfor
          -%}
          {%- if has_available_variant -%}
            {%- assign cards_rendered = cards_rendered | plus: 1 -%}
            {%- if cards_rendered > recommended_scroll_limit -%}{% break %}{% endif -%}
            {%- assign card_id = 'recommended-card-' | append: related_product.id | append: '-' | append: forloop.index -%}
            {%- assign form_id = 'recommended-form-' | append: related_product.id | append: '-' | append: forloop.index -%}
            {%- assign default_variant = related_product.selected_or_first_available_variant -%}
            {%- assign default_image = default_variant.featured_media | default: related_product.featured_media | default: related_product.featured_image -%}
          
          <div class="recommended-scroll-card-wrapper" data-product-id="{{ related_product.id }}">
            <script type="application/json" class="js-recommended-variants-data">
              {
                "productId": {{ related_product.id }},
                "variants": [
                  {%- for variant in related_product.variants -%}
                    {
                      "id": {{ variant.id }},
                      "available": {{ variant.available }},
                      "image": {% if variant.featured_media %}"{{ variant.featured_media | image_url: width: 360 }}"{% else %}null{% endif %},
                      "price": {{ variant.price }},
                      "price_formatted": "{{ variant.price | money }}",
                      "compare_at_price": {% if variant.compare_at_price %}{{ variant.compare_at_price }}{% else %}null{% endif %},
                      "compare_at_price_formatted": {% if variant.compare_at_price %}"{{ variant.compare_at_price | money }}"{% else %}null{% endif %},
                      "options": [
                        {%- for option in variant.options -%}
                          {{ option | json }}{% unless forloop.last %},{% endunless %}
                        {%- endfor -%}
                      ]
                    }{% unless forloop.last %},{% endunless %}
                  {%- endfor -%}
                ]
              }
            </script>
            <div class="recommended-scroll-card d-flex fd-column scrollable-aln-start">
              <a href="{{ related_product.url }}" class="recommended-scroll-card__link" title="{{ related_product.title | escape }}" tabindex="-1">
                <div class="recommended-scroll-card__media media-wrapper of-cover">
                  {%- liquid
                    assign img_width = 360
                    assign img_height = 360
                    if default_image.width and default_image.height
                      assign aspect_ratio = default_image.width | divided_by: default_image.height
                      if aspect_ratio > 1
                        assign img_height = 360 | divided_by: aspect_ratio | round
                      elsif aspect_ratio < 1
                        assign img_width = 360 | times: aspect_ratio | round
                      endif
                    endif
                  -%}
                  <img 
                    class="media recommended-scroll-card__image js-recommended-card-image" 
                    src="{{ default_image | image_url: width: 360 }}"
                    srcset="{{ default_image | image_url: width: 120 }} 120w, {{ default_image | image_url: width: 160 }} 160w, {{ default_image | image_url: width: 360 }} 360w"
                    sizes="(min-width: 769px) 160px, 120px"
                    alt="{{ default_image.alt | default: related_product.title }}"
                    width="{{ img_width }}"
                    height="{{ img_height }}"
                    decoding="async"
                    loading="lazy"
                    data-default-image="{{ default_image | image_url: width: 360 }}"
                    data-product-id="{{ related_product.id }}"
                  >
                </div>
              </a>
              
              <div class="recommended-scroll-card__info mt-8">
                <div class="recommended-scroll-card__price js-recommended-card-price" data-product-id="{{ related_product.id }}">
                  <span class="price-item price-item--regular price-item--last mt-4 mb-4 d-inline-block">{{ default_variant.price | money }}</span>

                </div>
              </div>
              
              {%- form 'product', related_product, id: form_id, class: 'recommended-scroll-card__form', novalidate: 'novalidate', data-type: 'add-to-cart-form' -%}
                <input type="hidden" name="id" value="{{ default_variant.id }}" class="js-recommended-variant-id" data-product-id="{{ related_product.id }}">
                
                <div class="recommended-scroll-card__form-content">
                  {%- unless related_product.has_only_default_variant -%}
                    <div class="recommended-scroll-card__variants">
                      {%- for option in related_product.options_with_values -%}
                        {%- assign option_index = forloop.index | minus: 1 -%}
                        <div class="recommended-scroll-card__variant-select">
                          <select 
                            class="form__control recommended-scroll-card__variant-select-input js-recommended-variant-select" 
                            id="{{ form_id }}-option-{{ option_index }}"
                            name="options[{{ option.name | escape }}]"
                            form="{{ form_id }}" 
                            data-product-id="{{ related_product.id }}"
                            data-option-index="{{ option_index }}"
                          >
                            {%- for value in option.values -%}
                              {%- liquid
                                assign option_disabled = true
                                for variant in related_product.variants
                                  if variant.options[option_index] == value and variant.available
                                    assign option_disabled = false
                                    break
                                  endif
                                endfor
                              -%}
                              <option 
                                value="{{ value | escape }}"
                                {% if default_variant.options[option_index] == value %}selected{% endif %}
                                {% if option_disabled %}disabled{% endif %}
                              >
                                {{ value }}{% if option_disabled %} - {{ 'products.product.unavailable' | t }}{% endif %}
                              </option>
                            {%- endfor -%}
                          </select>
                        </div>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <div class="recommended-scroll-card__variants-placeholder"></div>
                  {%- endunless -%}
                  
                  <button 
                    type="submit" 
                    name="add" 
                    class="recommended-scroll-card__add-to-cart btn btn-secondary btn-small w-100 js-recommended-add-to-cart"
                    data-product-id="{{ related_product.id }}"
                    {% if default_variant.available == false %}disabled{% endif %}
                  >
                    {%- if default_variant.available == false -%}
                      {{ 'products.product.sold_out' | t }}
                    {%- else -%}
                      {{ 'products.product.add_to_cart' | t }}
                    {%- endif -%}
                  </button>
                </div>
              {%- endform -%}
            </div>
          </div>
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
    </div>
  </div>

  {%- unless product_recommended_scroll_styles_loaded -%}
    {%- assign product_recommended_scroll_styles_loaded = true -%}
    <style>
      .product-recommended-scroll {
        margin-top: calc(var(--spacing) * 1.5);
      }
      .recommended-scroll-card-wrapper {
        min-width: 120px;
        scroll-snap-align: start;
        margin-right: calc(var(--spacing));
      }
      .recommended-scroll-card {
        gap: 8px;
        min-width: 100%;
        display: flex;
        flex-direction: column;
      }
      .recommended-scroll-card__link {
        text-decoration: none;
        display: block;
      }
      .recommended-scroll-card__media {
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 1/1;
        background-color: rgba(var(--color-normal-text-rgb), .06);
        position: relative;
      }
      .recommended-scroll-card__image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 0.3s ease;
      }
      .recommended-scroll-card__info {
        width: 100%;
      }
      .recommended-scroll-card__title {
        display: block;
        text-align: center;
        color: inherit;
        font-size: 12px;
        line-height: 1.4;
        font-weight: 500;
        margin: 0;
      }
      .recommended-scroll-card__price {
        font-size: 12px;
        line-height: 1.4;
        text-align: center;
      }
      .recommended-scroll-card__price .price-item {
        display: inline-block;
      }
      .recommended-scroll-card__form {
        width: 100%;
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .recommended-scroll-card__form-content {
        display: flex;
        flex-direction: column;
        flex: 1;
      }
      .recommended-scroll-card__variants {
        width: 100%;
        min-height: 60px;
      }
      .recommended-scroll-card__variants-placeholder {
        min-height: 60px;
        width: 100%;
      }
      .recommended-scroll-card__variant-select {
        width: 100%;
      }
      .recommended-scroll-card__variant-label {
        font-size: 0.9375rem;
        font-weight: 500;
        line-height: 1.4;
      }
      .recommended-scroll-card__variant-select-input {
        width: 100%;
        padding: 10px 12px;
        font-size: 12px;
        line-height: 1.4;
        border: 1px solid rgba(var(--color-normal-text-rgb), 0.2);
        border-radius: 4px;
        background-color: var(--color-background);
        text-align: center;
      }
      .recommended-scroll-card__variant-select-input option {
        text-align: center;
      }
      .recommended-scroll-card__add-to-cart {
        font-size: 15px;
        padding: 12px;
        line-height: 1.4;
        margin-top: auto;
      }
      .recommended-scroll-card__add-to-cart:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .recommended-scroll__container {
        display: flex;
        gap: calc(var(--spacing));
        padding-bottom: 8px;
        scroll-snap-type: x proximity;
        overflow-y: hidden;
        scrollbar-width: thin;
        scrollbar-color: #000000 #f5f5f5;
      }
      .recommended-scroll__container::-webkit-scrollbar {
        height: 4px;
      }
      .recommended-scroll__container::-webkit-scrollbar-track {
        background: #f5f5f5;
        border-radius: 999px;
      }
      .recommended-scroll__container::-webkit-scrollbar-thumb {
        background: #000000;
        border-radius: 999px;
      }
      .recommended-scroll__container::-webkit-scrollbar-button {
        display: none;
      }
      .recommended-scroll__container::-webkit-scrollbar-corner {
        display: none;
      }
      @media (min-width: 769px) {
        .recommended-scroll-card-wrapper {
          min-width: 200px;
        }
      }
    </style>
    
    <script>
      (function() {
        if (!document.querySelector('.recommended-scroll-card-wrapper')) return;
        
        // Store variant data for each product
        const variantData = {};
        
        // Initialize variant data from JSON scripts
        document.querySelectorAll('.js-recommended-variants-data').forEach(script => {
          try {
            const data = JSON.parse(script.textContent);
            variantData[data.productId] = data.variants;
          } catch (e) {
            console.error('Error parsing variant data:', e);
          }
        });
        
        // Handle variant selection change
        document.addEventListener('change', function(e) {
          if (!e.target.classList.contains('js-recommended-variant-select')) return;
          
          const select = e.target;
          const productId = parseInt(select.dataset.productId);
          const card = select.closest('.recommended-scroll-card-wrapper');
          const form = card.querySelector('form');
          const variantIdInput = form.querySelector('.js-recommended-variant-id');
          const image = card.querySelector('.js-recommended-card-image');
          const addToCartBtn = card.querySelector('.js-recommended-add-to-cart');
          
          // Get all selected options
          const selectedOptions = [];
          card.querySelectorAll('.js-recommended-variant-select').forEach(s => {
            selectedOptions.push(s.value);
          });
          
          // Find matching variant
          const variants = variantData[productId];
          let matchedVariant = null;
          
          if (variants && variants.length > 0) {
            matchedVariant = variants.find(variant => {
              if (!variant.options || variant.options.length !== selectedOptions.length) return false;
              return variant.options.every((opt, idx) => opt === selectedOptions[idx]);
            });
          }
          
          if (matchedVariant) {
            // Update variant ID
            variantIdInput.value = matchedVariant.id;
            
            // Update image if variant has a different image
            if (matchedVariant.image && image) {
              const currentSrc = image.src.split('?')[0];
              const newImageSrc = matchedVariant.image.split('?')[0];
              if (currentSrc !== newImageSrc) {
                image.style.opacity = '0';
                setTimeout(() => {
                  image.src = matchedVariant.image;
                  // Generate srcset with different sizes
                  const baseUrl = matchedVariant.image;
                  const url120 = baseUrl.replace(/width=\d+/i, 'width=120').replace(/_(\d+)x(\d+)/i, '_120x120');
                  const url160 = baseUrl.replace(/width=\d+/i, 'width=160').replace(/_(\d+)x(\d+)/i, '_160x160');
                  image.srcset = url120 + ' 120w, ' + url160 + ' 160w, ' + baseUrl + ' 360w';
                  // Maintain width and height attributes (images are square 1:1 aspect ratio)
                  if (!image.width) image.width = 360;
                  if (!image.height) image.height = 360;
                  image.style.opacity = '1';
                }, 150);
              }
            }
            
            // Update price
            const priceElement = card.querySelector('.js-recommended-card-price');
            if (priceElement && matchedVariant.price_formatted) {
              const priceHtml = matchedVariant.compare_at_price && matchedVariant.compare_at_price > matchedVariant.price
                ? `<span class="price-item price-item--last mt-4 mb-4 d-inline-block">${matchedVariant.price_formatted}</span><s class="price-item price-item--regular color-light subtext d-inline-block ml-8">${matchedVariant.compare_at_price_formatted}</s>`
                : `<span class="price-item price-item--regular price-item--last mt-4 mb-4 d-inline-block">${matchedVariant.price_formatted}</span>`;
              priceElement.innerHTML = priceHtml;
            }
            
            // Update add to cart button
            if (addToCartBtn) {
              if (matchedVariant.available) {
                addToCartBtn.disabled = false;
                addToCartBtn.textContent = addToCartBtn.dataset.addToCartText || '{{ 'products.product.add_to_cart' | t }}';
              } else {
                addToCartBtn.disabled = true;
                addToCartBtn.textContent = addToCartBtn.dataset.soldOutText || '{{ 'products.product.sold_out' | t }}';
              }
            }
          }
        });
        
        // Store button text in data attributes for later use
        document.querySelectorAll('.js-recommended-add-to-cart').forEach(btn => {
          if (!btn.dataset.addToCartText) {
            btn.dataset.addToCartText = btn.textContent.trim();
          }
          if (!btn.dataset.soldOutText) {
            btn.dataset.soldOutText = '{{ 'products.product.sold_out' | t }}';
          }
        });
      })();
    </script>
  {%- endunless -%}
{%- endif -%}
